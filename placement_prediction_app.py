# -*- coding: utf-8 -*-
"""Placement Prediction App.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1KQpIpU82SFIV4_Izar63_KrbpASCSv7i
"""

import streamlit as st
import pandas as pd
import numpy as np

from sklearn.model_selection import train_test_split
from sklearn.preprocessing import StandardScaler, LabelEncoder
from sklearn.metrics import (
    accuracy_score,
    roc_auc_score,
    precision_score,
    recall_score,
    f1_score,
    matthews_corrcoef,
    confusion_matrix,
    classification_report
)

from sklearn.linear_model import LogisticRegression
from sklearn.tree import DecisionTreeClassifier
from sklearn.neighbors import KNeighborsClassifier
from sklearn.naive_bayes import GaussianNB
from sklearn.ensemble import RandomForestClassifier
from xgboost import XGBClassifier

import matplotlib.pyplot as plt
import seaborn as sns
from pathlib import Path
# --------------------------------------------------
# PAGE CONFIG
# --------------------------------------------------
st.set_page_config(page_title="ML Assignment 02", layout="centered")
st.title("ðŸŽ“ Student Placement Prediction App")
st.write("Classification-based Machine Learning Models")



# --------------------------------------------------
# DOWNLOAD SAMPLE DATASET (LOCAL FILE)
# --------------------------------------------------
st.header("â¬‡ï¸ Download Sample Dataset")

st.write(
    "Download a sample CSV file to understand the required format. "
    "You can upload this file directly to test the app."
)

csv_path = Path(__file__).parent / "student_academic_placement_performance_dataset.csv"

if csv_path.exists():
    with open(csv_path, "rb") as file:
        st.download_button(
            label="ðŸ“¥ Download Sample CSV",
            data=file,
            file_name="student_academic_placement_performance_dataset.csv",
            mime="text/csv"
        )
else:
    st.error("Sample CSV file not found in app directory.")

# --------------------------------------------------
# DATASET UPLOAD
# --------------------------------------------------
st.header("ðŸ“‚ Upload Dataset (CSV)")
uploaded_file = st.file_uploader(
    "Upload CSV file",
    type=["csv"]
)

if uploaded_file is None:
    st.warning("Please upload a CSV file to proceed.")
    st.stop()

df = pd.read_csv(uploaded_file)


# Drop serial number if present
if "sl_no" in df.columns:
    df.drop(columns=["sl_no"], inplace=True)

# Validate target column
if "placement_status" not in df.columns:
    st.error("Dataset must contain 'placement_status' column.")
    st.stop()

# --------------------------------------------------
# DATA PREVIEW
# --------------------------------------------------
st.subheader("ðŸ“„ Dataset Preview")
st.dataframe(df.head())

# --------------------------------------------------
# ENCODE CATEGORICAL FEATURES
# --------------------------------------------------
le = LabelEncoder()
for col in df.select_dtypes(include="object").columns:
    df[col] = le.fit_transform(df[col])

# --------------------------------------------------
# SALARY RANGE CREATION (4 RANGES)
# --------------------------------------------------
df["salary_range"] = np.where(
    df["placement_status"] == 1,
    pd.cut(
        df["salary_package_lpa"],
        bins=[0, 3, 5, 10, 15],
        labels=[
            "Low (â‰¤3 LPA)",
            "Medium (3â€“5 LPA)",
            "High (5â€“10 LPA)",
            "Very High (10-15 LPA)"
        ], include_lowest=True),
    "Not Placed"
    )
salary_order = [
    "Low (â‰¤3 LPA)",
    "Medium (3â€“5 LPA)",
    "High (5â€“10 LPA)",
    "Very High (10-15 LPA)",
    "Not Placed"
]

df["salary_range"] = pd.Categorical(
    df["salary_range"],
    categories=salary_order,
    ordered=True
)

salary_counts = df["salary_range"].value_counts(sort=False)

import matplotlib.pyplot as plt

ax = salary_counts.plot(kind="bar")

for container in ax.containers:
    ax.bar_label(container, padding=3)

plt.show()



# --------------------------------------------------
# FEATURE & TARGET SPLIT
# --------------------------------------------------
X = df.drop(columns=["placement_status", "salary_package_lpa", "salary_range"], errors="ignore")
y = df["placement_status"].astype(int)

scaler = StandardScaler()
X_scaled = scaler.fit_transform(X)

X_train, X_test, y_train, y_test = train_test_split(
    X_scaled,
    y,
    test_size=0.2,
    random_state=42,
    stratify=y
)

# --------------------------------------------------
# MODEL SELECTION
# --------------------------------------------------
st.header("ðŸ§  Select Classification Model")

model_name = st.selectbox(
    "Choose Model",
    (
        "Logistic Regression",
        "Decision Tree",
        "kNN",
        "Naive Bayes",
        "Random Forest (Ensemble)",
        "XGBoost (Ensemble)"
    )
)

if model_name == "Logistic Regression":
    model = LogisticRegression(max_iter=1000)

elif model_name == "Decision Tree":
    model = DecisionTreeClassifier(random_state=42)

elif model_name == "kNN":
    model = KNeighborsClassifier(n_neighbors=5)

elif model_name == "Naive Bayes":
    model = GaussianNB()

elif model_name == "Random Forest (Ensemble)":
    model = RandomForestClassifier(n_estimators=200, random_state=42)

else:
    model = XGBClassifier(
        objective="binary:logistic",
        eval_metric="logloss",
        use_label_encoder=False,
        random_state=42
    )

# --------------------------------------------------
# TRAIN MODEL
# --------------------------------------------------
with st.spinner("Training model..."):
    model.fit(X_train, y_train)

y_pred = model.predict(X_test)
y_prob = model.predict_proba(X_test)[:, 1]

# --------------------------------------------------
# EVALUATION METRICS
# --------------------------------------------------
st.header("ðŸ“Š Evaluation Metrics")

auc_value = roc_auc_score(y_test, y_prob) if len(np.unique(y_test)) > 1 else np.nan

metrics_df = pd.DataFrame({
    "Metric": [
        "Accuracy",
        "AUC",
        "Precision",
        "Recall",
        "F1 Score",
        "MCC"
    ],
    "Value": [
        accuracy_score(y_test, y_pred),
        auc_value,
        precision_score(y_test, y_pred),
        recall_score(y_test, y_pred),
        f1_score(y_test, y_pred),
        matthews_corrcoef(y_test, y_pred)
    ]
})

st.table(metrics_df.style.format({"Value": "{:.3f}"}))

st.caption(
    "Accuracy: Overall correctness | "
    "AUC: Class separability | "
    "MCC: Balanced performance metric"
)

# --------------------------------------------------
# CONFUSION MATRIX
# --------------------------------------------------
st.header("ðŸ“‰ Model Performance Analysis")

cm = confusion_matrix(y_test, y_pred)

fig, ax = plt.subplots()
sns.heatmap(
    cm,
    annot=True,
    fmt="d",
    cmap="Blues",
    xticklabels=["Not Placed", "Placed"],
    yticklabels=["Not Placed", "Placed"]
)
ax.set_xlabel("Predicted Label")
ax.set_ylabel("True Label")
st.pyplot(fig)

st.subheader("ðŸ“„ Classification Report")
st.text(classification_report(y_test, y_pred))

# --------------------------------------------------
# SALARY RANGE DISTRIBUTION
# --------------------------------------------------
if "salary_range" in df.columns:

    st.header("ðŸ’° Salary Range Distribution")

    salary_dist = df["salary_range"].value_counts().sort_index()

    fig2, ax2 = plt.subplots()
    salary_dist.plot(kind="bar", ax=ax2)

    ax2.set_xlabel("Salary Range")
    ax2.set_ylabel("Number of Students")
    ax2.set_title("Student Salary Package Distribution")

    st.pyplot(fig2)

# --------------------------------------------------
# SALARY RANGE vs PLACEMENT STATUS
# --------------------------------------------------
if "salary_range" in df.columns:

    st.header("ðŸ“ˆ Placement Status vs Salary Range")

    cross_tab = pd.crosstab(
        df["salary_range"],
        df["placement_status"]
    )

    fig3, ax3 = plt.subplots()
    cross_tab.plot(kind="bar", stacked=True, ax=ax3)

    ax3.set_xlabel("Salary Range")
    ax3.set_ylabel("Number of Students")
    ax3.set_title("Placement Outcome Across Salary Ranges")
    ax3.legend(["Not Placed", "Placed"])

    st.pyplot(fig3)
